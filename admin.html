<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#e01287',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100">

    <div id="login-section" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-center text-gray-900">Admin Login</h1>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email" required class="w-full px-3 py-2 border rounded-md focus:ring-brand focus:border-brand">
                <input type="password" id="password" placeholder="Password" required class="w-full px-3 py-2 border rounded-md focus:ring-brand focus:border-brand">
                <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-brand rounded-md hover:bg-opacity-90">Login</button>
            </form>
            <div id="login-error" class="hidden text-center text-red-500"></div>
        </div>
    </div>

    <div id="dashboard-section" class="hidden p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Admin Dashboard</h1>
            <div>
                <button id="add-card-btn" class="px-4 py-2 mr-2 font-medium text-white bg-brand rounded-md hover:bg-opacity-90">Add Card</button>
                <button id="logout-btn" class="px-4 py-2 font-medium text-white bg-gray-600 rounded-md hover:bg-gray-700">Logout</button>
            </div>
        </div>
        <div id="response-message" class="mb-4 text-center"></div>
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Card ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Created</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="cards-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="card-modal" class="hidden fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <form id="card-form" class="p-6 space-y-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Add New Card</h3>
                    <input type="hidden" id="modal-row-index">
                    <div>
                        <label for="modal-card-id" class="block text-sm font-medium text-gray-700">Card ID</label>
                        <input type="text" id="modal-card-id" required class="w-full px-3 py-2 mt-1 border rounded-md">
                    </div>
                    <div>
                        <label for="modal-balance" class="block text-sm font-medium text-gray-700">Balance</label>
                        <input type="number" id="modal-balance" step="0.01" required class="w-full px-3 py-2 mt-1 border rounded-md">
                    </div>
                    <div>
                        <label for="modal-status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="modal-status" required class="w-full px-3 py-2 mt-1 border rounded-md">
                            <option>Active</option>
                            <option>Used</option>
                            <option>Expired</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-brand text-base font-medium text-white hover:bg-opacity-90 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                        <button type="button" id="cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // IMPORTANT: Replace with your deployed Google Apps Script Web App URL
        const WEB_APP_URL = 'YOUR_WEB_APP_URL';
        const user = { email: null, token: null };

        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const responseMessage = document.getElementById('response-message');
        const tableBody = document.getElementById('cards-table-body');
        const modal = document.getElementById('card-modal');

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');

            try {
                const res = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'login', role: 'admin', email, password })
                });
                const data = await res.json();
                if (data.success) {
                    user.email = email;
                    user.token = data.token;
                    sessionStorage.setItem('user', JSON.stringify(user));
                    showDashboard();
                } else {
                    throw new Error(data.message);
                }
            } catch (err) {
                loginError.textContent = `Login Failed: ${err.message}`;
                loginError.classList.remove('hidden');
            }
        });

        function showDashboard() {
            loginSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            loadCards();
        }

        async function loadCards() {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Loading...</td></tr>';
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getCards&email=${user.email}&token=${user.token}`);
                const data = await res.json();
                if (data.success) {
                    renderTable(data.data);
                } else {
                    throw new Error(data.message);
                }
            } catch (err) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-red-500">Error: ${err.message}</td></tr>`;
            }
        }

        function renderTable(cards) {
            tableBody.innerHTML = '';
            if (cards.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No gift cards found.</td></tr>';
                return;
            }
            cards.forEach((card, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${card.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">$${card.balance.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${card.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${card.createdBy}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(card.dateCreated).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="openModal(true, ${index + 2})" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                        <button onclick="deleteCard('${card.id}', ${index + 2})" class="text-red-600 hover:text-red-900 ml-4">Delete</button>
                    </td>
                `;
                // Store data in the row element for easy access
                row.dataset.card = JSON.stringify(card);
                row.dataset.rowIndex = index + 2; // Sheet rows are 1-based, +1 for header
                tableBody.appendChild(row);
            });
        }
        
        function openModal(isEdit = false, rowIndex = null) {
            const form = document.getElementById('card-form');
            form.reset();
            document.getElementById('modal-title').textContent = isEdit ? 'Edit Card' : 'Add New Card';
            document.getElementById('modal-row-index').value = isEdit ? rowIndex : '';
            document.getElementById('modal-card-id').readOnly = isEdit;

            if (isEdit) {
                const row = document.querySelector(`[data-row-index='${rowIndex}']`);
                const card = JSON.parse(row.dataset.card);
                document.getElementById('modal-card-id').value = card.id;
                document.getElementById('modal-balance').value = card.balance;
                document.getElementById('modal-status').value = card.status;
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        document.getElementById('add-card-btn').addEventListener('click', () => openModal());
        document.getElementById('cancel-btn').addEventListener('click', closeModal);

        document.getElementById('card-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rowIndex = document.getElementById('modal-row-index').value;
            const isEdit = !!rowIndex;
            
            const body = {
                action: isEdit ? 'updateCard' : 'addCard',
                id: document.getElementById('modal-card-id').value,
                balance: document.getElementById('modal-balance').value,
                status: document.getElementById('modal-status').value,
                rowIndex: rowIndex,
                email: user.email,
                token: user.token
            };

            await handlePostRequest(body, `Card ${isEdit ? 'updated' : 'added'} successfully!`);
            closeModal();
            loadCards();
        });

        async function deleteCard(id, rowIndex) {
            if (!confirm(`Are you sure you want to delete card ${id}?`)) return;
            
            await handlePostRequest({
                action: 'deleteCard',
                id,
                rowIndex,
                email: user.email,
                token: user.token
            }, 'Card deleted successfully!');
            loadCards();
        }

        async function handlePostRequest(body, successMsg) {
            responseMessage.textContent = 'Processing...';
            responseMessage.className = 'mb-4 text-center text-gray-700';
            try {
                const res = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.success) {
                    responseMessage.textContent = successMsg;
                    responseMessage.className = 'mb-4 text-center text-green-500';
                } else {
                    throw new Error(data.message);
                }
            } catch (err) {
                responseMessage.textContent = `Error: ${err.message}`;
                responseMessage.className = 'mb-4 text-center text-red-500';
            }
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('user');
            window.location.reload();
        });

        // Check session
        const storedUser = sessionStorage.getItem('user');
        if (storedUser) {
            Object.assign(user, JSON.parse(storedUser));
            showDashboard();
        }
    </script>
</body>
</html>
